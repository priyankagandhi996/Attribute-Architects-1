<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Timesheets</title>
  <link rel="stylesheet" href="../stylesheets/employee.css">
</head>
<body>
  <div class="optionsContainer">
    <button onclick="showTimeSheet()"> TimeSheet </button>
    <button onclick="showBankDetails()"> Bank Details </button>
    <button onclick="showProfileDetails()"> Profile Details </button>
  </div>

  <div class="container timesheet">
    <h1>Your Timesheets</h1>

    <div class="form-row">
      <div class="form-group">
        <label for="EmployeeID">Enter EmployeeID:</label>
        <input type="text" id="EmployeeID">
      </div>
    </div>

    <form class="addTimesheetForm" onsubmit="event.preventDefault(); insertTimesheet();">
      <div class="form-row">
        <div class="form-group">
          <label for="PayPeriod">Pay Period:</label>
          <input type="text" id="PayPeriod">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="HoursWorked">Hours Worked:</label>
          <input type="text" id="HoursWorked">
        </div>
      </div>
      <!-- You don't need to input TimeSheetID and M_Approval; they will be set in the backend -->
      <button type="submit">Insert Timesheet</button>
    </form>

    <form class="addEmployeeForm" onsubmit="event.preventDefault(); fetchAndPopulateData();">
      <button type="submit">Get Timecard Data</button>
    </form>
    
    <table id="employeeTable">
      <thead>
        <tr>
          <th>Pay Period</th>
          <th>Hours Worked</th>
          <th>Approved</th>
        </tr>
      </thead>
      <tbody id="employeeData">
        <!-- Table data will be dynamically populated here -->
      </tbody>
    </table>
  </div>
  <div class="container bankdetails">
    <h1>Your BankDetails</h1>

    <div class="form-row">
      <div class="form-group">
        <label for="EmployeeID2">Enter EmployeeID:</label>
        <input type="text" id="EmployeeID2">
      </div>
    </div>

    <form class="addBankDetailsForm" onsubmit="event.preventDefault(); insertBankDetails();">
      <div class="form-row">
        <div class="form-group">
          <label for="AccNumber">Account Number</label>
          <input type="text" id="AccNumber">
        </div>
      </div>
      <button type="submit">Insert Bank Details</button>
    </form>

    <form class="addEmployeeForm" onsubmit="event.preventDefault(); fetchAndPopulateBankDetails();">
      <button type="submit">Get Bank Details</button>
    </form>
    
    <table id="employeeTable">
      <thead>
        <tr>
          <th>Employee id</th>
          <th>Account Number</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="employeeBankDetails">
        <!-- Table data will be dynamically populated here -->
      </tbody>
    </table>
  </div>
  <div class="container profileDetail">
    <h1>Profile Details</h1>

    <div class="form-row">
      <div class="form-group">
        <label for="EmployeeID3">Enter EmployeeID:</label>
        <input type="text" id="EmployeeID3">
         <button type="submit">Search Employee</button>
      </div>
    </div>

    <form class="profileDetailForm" id="profileDetailForm">
      <div class="form-row">
        <div class="form-group">
          <label for="EmployeeID">Employee ID:</label>
          <input type="text" id="EmployeeID" required>
        </div>
        <div class="form-group">
          <label for="F_Name">First Name:</label>
          <input type="text" id="F_Name" >
        </div>
        <div class="form-group">
          <label for="L_Name">Last Name:</label>
          <input type="text" id="L_Name" >
        </div>
        <div class="form-group">
          <label for="B_Date">Birth Date:</label>
          <input type="text" id="B_Date">
        </div>
        <div class="form-group">
          <label for="Address">Address:</label>
          <input type="text" id="Address" >
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="Email">Email:</label>
          <input type="text" id="Email">
        </div>
        <div class="form-group">
          <label for="DepartmentID">Department ID:</label>
          <input type="text" id="DepartmentID">
        </div>
        <div class="form-group">
          <label for="Position">Position:</label>
          <input type="text" id="Position" >
        </div>
        <div class="form-group">
          <label for="Wage">Wage:</label>
          <input type="text" id="Wage" >
        </div>
        <div class="form-group">
          <label for="ManagerID">Manager ID:</label>
          <input type="text" id="ManagerID" >
        </div>
      </div>
      <button type="submit">Update Details</button>
    </form>
  </div>

  <script>
    async function insertTimesheet() {
      const employeeID = document.getElementById('EmployeeID').value;
      const payPeriod = document.getElementById('PayPeriod').value;
      const hoursWorked = document.getElementById('HoursWorked').value;

      try {
        const response = await fetch('/insertTimesheet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            TimeSheetID: getRandom4DigitNumber(),
            EmployeeID: employeeID,
            PayPeriod: payPeriod,
            HoursWorked: hoursWorked,
            M_Approval: 'N'  // Default M_Approval to 'N'
          })
        });

        const data = await response.json();

        console.log('Response Data:', data);

        if (data.success) {
          // Reload or update the table to show the new timesheet
          fetchAndPopulateData();
        } else {
          console.error('Error:', data.message);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Function to generate a random 4-digit number
    function getRandom4DigitNumber() {
      return Math.floor(1000 + Math.random() * 9000);
    }

    // Function to fetch and populate existing timesheet data
    async function fetchAndPopulateData() {
      const employeeID = document.getElementById('EmployeeID').value;

      try {
        const response = await fetch(`/timesheetsForEmployees/${employeeID}`);
        const data = await response.json();

        console.log('Response Data:', data);

        if (data && data.length > 0) {
          // Clear existing table rows
          const tableBody = document.getElementById('employeeData');
          tableBody.innerHTML = '';

          // Loop through the retrieved data and append rows to the table
          data.forEach(entry => {
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = entry.PayPeriod;
            row.insertCell(1).textContent = entry.HoursWorked;
            row.insertCell(2).textContent = entry.M_Approval;
          });
        } else {
          console.error('Error:', data.message || 'No data found');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

  async function showTimeSheet() {
    var bankDetail = document.getElementsByClassName("bankDetails");
      bankDetail[0].style.display = "none";
    var profileDetail = document.getElementsByClassName("profileDetail");
      profileDetail[0].style.display = "none";
    var x = document.getElementsByClassName("timesheet");
    x[0].style.display = "block";
  }
  async function showBankDetails() {
    var tsheetdiv = document.getElementsByClassName("timesheet");
      tsheetdiv[0].style.display = "none"
    var profileDetail = document.getElementsByClassName("profileDetail");
      profileDetail[0].style.display = "none";
    var x = document.getElementsByClassName("bankdetails");
      x[0].style.display = "block";
  }
  async function showProfileDetails() {
    var tsheetdiv = document.getElementsByClassName("timesheet");
      tsheetdiv[0].style.display = "none"
    var bankDetail = document.getElementsByClassName("bankdetails");
      bankDetail[0].style.display = "none";
    var profileDetail = document.getElementsByClassName("profileDetail");
      profileDetail[0].style.display = "block";
    
  }
  async function insertBankDetails() {
      const employeeID = document.getElementById('EmployeeID2').value;
      const accNumber = document.getElementById('AccNumber').value;

      try {
        const response = await fetch('/insertBankDetails', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            BankID: getRandom4DigitNumber(),
            EmployeeID: employeeID,
            BANKACCTNO: accNumber,
            PaymentType: 'Check'//Default as check, if account number is provided.
          })
        });

        const data = await response.json();

        console.log('Response Data:', data);

        if (data.success) {
          // Reload or update the table to show the new timesheet
          fetchAndPopulateBankDetails();
        } else {
          console.error('Error:', data.message);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }


    async function fetchAndPopulateBankDetails() {
      const employeeID = document.getElementById('EmployeeID2').value;

      try {
        const response = await fetch(`/bankDetailsForEmployee/${employeeID}`);
        const data = await response.json();

        console.log('Response Data:', data);

        if (data && data.length > 0) {
          // Clear existing table rows
          const tableBody = document.getElementById('employeeBankDetails');
          tableBody.innerHTML = '';

          // Loop through the retrieved data and append rows to the table
          data.forEach(entry => {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td>${entry.EmployeeID}</td>
                        <td>${entry.bankAcctNo}</td>
                         <td>
                            <button class="deleteBtn" onclick="deleteBankDetail(${entry.bankid})">Delete</button>
                        </td>`;
                        tableBody.appendChild(row);
          });
        } else {
          console.error('Error:', data.message || 'No data found');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

   function deleteBankDetail(bankid) {
        fetch('/deletebankDetail', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bankid }),
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            fetchAndPopulateBankDetails();
        })
        .catch(error => console.error('Error deleting bank detail:', error));
    }

  </script>
</body>
</html>
